<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="1-click OpenBazaar!">
  <title>EasyBazaar: 1-click deployment of OpenBazaar</title>
  <link rel="icon" type="image/png" href="/images/favicon.png" />

  <!-- inject:css -->
  <link href="assets/vendor/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u">
  <link href="assets/vendor/css/one-page-wonder.css">
  <!-- endinject -->
</head>
<body id="app">
  <!-- Navbar -->
  <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">EasyBazaar</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="https://openbazaar.org/?ref=easybazaar" target="_blank">Get OpenBazaar</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Full Width Image Header -->
  <header class="header-image">
      <div class="headline">
          <div class="container">
              <h1>EasyBazaar</h1>
              <h3>1-click deployment of OpenBazaar.</h3>
          </div>
      </div>
  </header>
  </br>

  <!-- Page Content -->
  <div class="container">
    <div class="featurette">
      </br><p class="lead">Setting up your OpenBazaar store to be online 24/7 can be tricky. EasyBazaar is a convenient 1-click solution to create a Digital Ocean droplet (virtual private server) installed with OpenBazaar.</p></br>
    </div>
    <hr>

    <!-- Step 1: Sign-up -->
    <div class="featurette" id="step1">
      <img class="featurette-image img-responsive pull-right" src="/images/signup.png" width="500px">
      <h2 class="featurette-heading">Step 1:
          <span class="text-muted">Sign-up to Digital Ocean for Free</span>
      </h2>
      <p class="lead">To get started, you need to sign-up to Digital Ocean. </br></br><a href="https://m.do.co/c/eaa306f7dd3d"><strong>If you join using this link</strong></a>, you'll receive $10 credit, which is about 2 months of running OpenBazaar for free! After that, it's only $5/month.</p>
    </div>
    <hr class="featurette-divider">

    <!-- Step 2: Copy the API Token -->
    <div class="featurette" id="step2">
    <img class="featurette-image img-responsive pull-left" src="/images/token_instructions.gif" width="500px">
      <h2 class="featurette-heading">Step 2:
        <span class="text-muted">Copy the API token</span>
      </h2>
      <p class="lead">Generate a new token, as per the gif to the left. Make sure it has both <code>read</code> and <code>write</code> access. Copy the token and go to Step 3.</p>
    </div>
    <hr class="featurette-divider">

    <!-- Step 3: Deploy -->
    <div class="featurette" id="step3">
      <div class="well well-lg featurette-image col-lg-5 col-md-5 col-sm-12 col-xs-12 img-responsive pull-right"><p id="dasinfo" style="word-wrap: break-word;"><code>Ready. Add your API token and click 'Deploy!'.</code></p></br></br></br></br></br></br></br></br></br></div>
      <h2 class="featurette-heading">Step 3:
        <span class="text-muted">Add the token and click 'Deploy'</span>
      </h2>
      <p class="lead">Add your API token from Step 2 and click the button below... easy as that!</p>

      <!-- VPS Creation Form -->
      <form id="createVPS">
        <div class="input-group input-group-lg">
          <span class="input-group-addon" id="sizing-addon1">Token:</span>
          <input class="form-control" aria-describedby="sizing-addon1" type="text" id="token" name="token" placeholder="e.g. abcdefg123456789868ac60920f00152840475b63607d543ce89d3d42b66bc6a"/>
          <input hidden name="size" value="512mb" />
          <input hidden name="region" value="sfo2" />
        </div>
        </br>
        <button type="submit" name="submit" class="btn btn-info btn-lg">Deploy!</button>
      </form>
    </div>
    <hr class="featurette-divider">

    <!-- Step 4: Download OB -->
    <div class="featurette" id="step4">
      <img class="featurette-image img-responsive pull-left" src="/images/download-ob.gif" width="500px">
      <h2 class="featurette-heading">Step 4:
        <span class="text-muted">Get OpenBazaar</span>
      </h2>
      <p class="lead"><a href="https://openbazaar.org">Download OpenBazaar</a> and install it on your computer.</br></br>When you run it for the first time, a local node will be created by default. After you complete setting up your local node, go to Step 5.</p>
    </div>
    <hr class="featurette-divider">

    <!-- Step 5: Connect -->
    <div class="featurette" id="step5">
      <img class="featurette-image img-responsive pull-right" src="/images/connect.gif" width="500px">
      <h2 class="featurette-heading">Step 5:
          <span class="text-muted">Connect to your store</span>
      </h2>
      <p class="lead">Add your 'EasyBazaar' OpenBazaar node to your list of connections. Then login and setup your store!</p>
    </div>
    <hr class="featurette-divider">
  </div>

  <!-- Footer -->
  <div class="container">
    <footer>
      <div class="row">
        <div class="col-lg-12">
          <p><strong>Github:</strong> <a href="https://github.com/OpenBazaar/miniprovistor-web">https://github.com/OpenBazaar/miniprovistor-web</a></p>
        </div>
      </div>
    </footer>
  </div>

  <!-- inject:js -->
  <script src="assets/vendor/js/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"></script>
  <script src="assets/vendor/js/bip39.js" integrity="sha384-1vEl6sL2x2obq68vSVfonhhp2h8jh9AZHZExZqtMfBFHU3Rfp4sL3o9vsDvz26GQ"></script>
  <script src="assets/js/digitalocean.js"></script>
  <script src="assets/js/app.js"></script>
  <!-- endinject -->
</body>

<!-- Installation script. It must not have a newline before the shebang -->
<script type="text/bash" id="cloud-init-script-template">#!/bin/bash

##
## Install OpenBazaar and ob-relay. The goal is to install ob-relay as
## quickly as possible so we can use it to communicate the installation
## status back to the end user. Only do the bare minimum first.
##

# Set state writes a string to a file that ob-relay can use to determine progress
mkdir -p /home/openbazaar/.easybazaar
function setState {
  echo -n $1 > /home/openbazaar/.easybazaar/state
}

setState INSTALLING_OB_RELAY

# Create openbazaar user and group
groupadd -f openbazaar
useradd --shell /bin/bash --create-home --home /home/openbazaar -g openbazaar --password $(openssl passwd -salt a -1 "{{vpsPassword}}") openbazaar

# Install git and nodejs
apt-key adv --keyserver keyserver.ubuntu.com --recv 68576280
apt-add-repository "deb https://deb.nodesource.com/node_6.x $(lsb_release -sc) main"
apt-get update
apt-get install -y git nodejs

# Install ob-relay
git clone https://github.com/OB1Company/ob-relay.git /home/openbazaar/ob-relay
cd /home/openbazaar/ob-relay && npm install
chown -R openbazaar:openbazaar /home/openbazaar/ob-relay
chmod -R 760 /home/openbazaar/ob-relay

setState STARTING_OB_RELAY

# Create Upstart script for ob-relay
cat > /etc/init/ob-relay.conf <<-EOF
setuid openbazaar
setgid openbazaar
chdir /home/openbazaar/ob-relay
respawn
start on runlevel [2345]
stop on runlevel [06]
exec node /home/openbazaar/ob-relay/app.js
EOF

# Start ob-relay
service ob-relay start

setState INSTALLING_SYSTEM_PACKAGES

# Update packages and do basic security hardening
apt-get upgrade -y

# Install fail2ban to block brute force SSH attempts
apt-get install -y fail2ban

# Disable incoming traffic except for the specified ports
ufw disable && ufw --force enable
ufw default deny incoming
ufw allow 22/tcp
ufw allow 8080/tcp
ufw allow 18466/tcp
ufw allow 18469/tcp
ufw allow 18470/tcp
ufw allow 18467/udp

setState INSTALLING_OPENBAZAAR_SERVER

# Install OpenBazaar-Server
apt-get install -y python2.7 build-essential python-dev libffi-dev libssl-dev
git clone https://github.com/OpenBazaar/OpenBazaar-Server.git /home/openbazaar/src
easy_install pip
pip install virtualenv
virtualenv --python=python2.7 /home/openbazaar/venv
/home/openbazaar/venv/bin/pip install -r /home/openbazaar/src/requirements.txt

# Generate SSL cert
mkdir /home/openbazaar/ssl
openssl req -nodes -batch -x509 -newkey rsa:2048 -keyout /home/openbazaar/ssl/easybazaar.key -out /home/openbazaar/ssl/easybazaar.crt
chmod -R 600 /home/openbazaar/ssl

# Create config file
cat > /home/openbazaar/ob.cfg <<-EOF
[CONSTANTS]
DATA_FOLDER = /home/openbazaar/data/
TRANSACTION_FEE = 20400
RESOLVER = https://resolver.onename.com/
[LIBBITCOIN_SERVERS]
mainnet_server1 = tcp://libbitcoin1.openbazaar.org:9091
mainnet_server3 = tcp://libbitcoin3.openbazaar.org:9091
mainnet_server5 = tcp://obelisk.airbitz.co:9091
[LIBBITCOIN_SERVERS_TESTNET]
testnet_server2 = tcp://libbitcoin2.openbazaar.org:9091,baihZB[vT(dcVCwkhYLAzah<t2gJ>{3@k?+>T&^3
testnet_server4 = tcp://libbitcoin4.openbazaar.org:9091,<Z&{.=LJSPySefIKgCu99w.L%b^6VvuVp0+pbnOM
[AUTHENTICATION]
SSL = True
SSL_CERT = /home/openbazaar/ssl/easybazaar.crt
SSL_KEY = /home/openbazaar/ssl/easybazaar.key
USERNAME = admin
PASSWORD = {{obPassword}}
[MAINNET_SEEDS]
mainnet_seed2 = seed2.openbazaar.org:8080,8b17082a57d648894a5181cb6e1b8a6f5b3b7e1c347c0671abfcd7deb6f105fe
mainnet_seed3 = seed.obcentral.org:8080,f0ff751b27ddaa86a075aa09785c438cd2cebadb8f0f5a7e16f383911322d4ee
[TESTNET_SEEDS]
testnet_seed1 = seed.openbazaar.org:8080,5b44be5c18ced1bc9400fe5e79c8ab90204f06bebacc04dd9c70a95eaca6e117
EOF

# Setup data directory and permissions
mkdir -p /home/openbazaar/data
chown -R openbazaar:openbazaar /home/openbazaar
chmod -R 760 /home/openbazaar
chmod 640 /home/openbazaar/ob.cfg

setState STARTING_OPENBAZAAR_SERVER

# Create Upstart script for OpenBazaar-Server
cat > /etc/init/openbazaard.conf <<-EOF
setuid openbazaar
setgid openbazaar
chdir /home/openbazaar
respawn
start on runlevel [2345]
stop on runlevel [06]
exec /home/openbazaar/venv/bin/python /home/openbazaar/src/openbazaard.py start -a 0.0.0.0
EOF

# Start OpenBazaar-Server
service openbazaard start

setState READY
</script>
</html>
